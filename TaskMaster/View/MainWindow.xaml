<!--
 This file is part of TaskMaster.
 Copyright (C) 2025 Aaron Semler

 TaskMaster is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<Window x:Class="TaskMaster.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vw="clr-namespace:TaskMaster.View"
        xmlns:dvw="clr-namespace:TaskMaster.View.Dialog"
        xmlns:vm="clr-namespace:TaskMaster.ViewModel"
        xmlns:ui="clr-namespace:TaskMaster.Presentation.UI"
        mc:Ignorable="d" 
        Title="TaskMaster"
        d:DataContext="{d:DesignInstance vm:MainWindowViewModel, IsDesignTimeCreatable=True}"
        Width="{Binding WindowMinWidth}"
        Height="{Binding WindowMinHeight}"
        MinWidth="{Binding WindowMinWidth}"
        MinHeight="{Binding WindowMinHeight}"
        SizeToContent="WidthAndHeight"
        ResizeMode="NoResize"
        WindowStyle="None"
        KeyboardNavigation.TabNavigation="None"
        FocusManager.IsFocusScope="True"
        Focusable="False"
        Background="Transparent"
        BorderBrush="Transparent"
        AllowsTransparency="True"
        BorderThickness="0"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True"
        RenderOptions.BitmapScalingMode="HighQuality">

    
    <Grid SnapsToDevicePixels="True"
          UseLayoutRounding="True"
          RenderOptions.BitmapScalingMode="HighQuality"
          MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">

        <!-- Scale entire UI based on UiScale property -->
        <Grid.LayoutTransform>
            <TransformGroup>
                <ScaleTransform ScaleX="{Binding UiScale}"
                                ScaleY="{Binding UiScale}"/>
            </TransformGroup>
        </Grid.LayoutTransform>

        <!-- ==== ==== ==== ==== Main Window View Contents ==== ==== ==== ==== -->
        <Border Background="{DynamicResource Brush.Window.Background}"
                BorderBrush="{DynamicResource Brush.Window.Border}"
                BorderThickness="1"
                CornerRadius="{DynamicResource CornerRadius.CurrentStyle}">

            <Grid>
                <!-- Layout rows: Titlebar, Tab strip, Content -->
                <Grid.RowDefinitions>
                    <RowDefinition Height="{StaticResource Grid.TitleBar.Height}"/>
                    <RowDefinition Height="{StaticResource Grid.TabStrip.Height}"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- ===================== Custom Title Bar ===================== -->
                <Border Grid.Row="0" Grid.RowSpan="2"
                        Background="{DynamicResource Brush.Panel.Background}"
                        BorderBrush="{DynamicResource Brush.Window.Border}"
                        CornerRadius="{DynamicResource CornerRadius.CurrentStyle}"
                        BorderThickness="1">
                    
                    <Grid VerticalAlignment="Top">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Image Icon to left of Title (default for designer can replaced at runtime - see codebehind) -->
                        <Image Grid.Column="0" Width="32" Height="32" Margin="10,2,6,4" Style="{StaticResource Image.TitleBar.App}"/>
                        <TextBlock Grid.Column="1" Grid.ColumnSpan="1" VerticalAlignment="Center" Margin="10,0,0,0"
                                   Style="{StaticResource TextBlock.Title}">
                            <Run Text="{DynamicResource Text.App.Title}"/>
                            <Run x:Name="TitleBarSuffix"/>
                        </TextBlock>

                        <!-- Window control buttons to right of Title -->
                        <!-- Help -->
                        <Button Grid.Column="3" Width="46" Height="42" Margin="0,0,0,0"
                                HorizontalAlignment="Right" VerticalAlignment="Center"
                                Style="{DynamicResource Button.Square.ImageSource.Help}"
                                ToolTip="{DynamicResource ToolTip.Button.Help}"
                                Command="{Binding DataContext.HelpCommand, RelativeSource={RelativeSource AncestorType=Window}}">
                        </Button>

                        <!-- Minimize -->
                        <Button Grid.Column="4" Width="46" Height="28" Margin="8,4,4,6" HorizontalAlignment="Right"
                                Style="{DynamicResource Button.Minimize}"
                                ToolTip="{DynamicResource ToolTip.Button.Minimize}"
                                Command="{Binding DataContext.MinimizeCommand, RelativeSource={RelativeSource AncestorType=Window}}">
                            <TextBlock VerticalAlignment="Center" HorizontalAlignment="Right"
                                       FontSize="{StaticResource Font.Size}" Text="—"/>
                        </Button>

                        <!-- Close -->
                        <Button Grid.Column="5" Width="46" Height="28" Margin="0,4,8,6"
                                Style="{DynamicResource Button.Close}"
                                ToolTip="{DynamicResource ToolTip.Button.Close}"
                                Command="{Binding DataContext.CloseCommand, RelativeSource={RelativeSource AncestorType=Window}}">
                            <TextBlock VerticalAlignment="Center" HorizontalAlignment="Center"
                                       FontSize="{StaticResource Font.Size.Small}" FontWeight="ExtraBold" Text="✕"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- ===================== Tabs ===================== -->
                <TabControl Grid.Row="1" Grid.RowSpan="2"
                            SelectedValue="{Binding ActiveTab, Mode=TwoWay}"
                            SelectedValuePath="Tag"
                            ui:TabItemChrome.CornerRadius="0">
                    <TabItem Style="{StaticResource TabItem.Left}"
                             ui:TabItemChrome.CornerRadius="{Binding ItemTabRadiusLeft}"
                             Header="{DynamicResource Text.Tab.Launcher}"
                             Tag="{x:Static vm:AppTab.TaskLauncher}"
                             Content="{Binding Launcher}"/>
                    <TabItem Header="{DynamicResource Text.Tab.Killer}"
                             Tag="{x:Static vm:AppTab.TaskKiller}"
                             Content="{Binding Killer}"/>
                    <TabItem Style="{StaticResource TabItem.Right}"
                             ui:TabItemChrome.CornerRadius="{Binding ItemTabRadiusRight}"
                             Header="{DynamicResource Text.Tab.Settings}"
                             Tag="{x:Static vm:AppTab.Settings}"
                             Content="{Binding Settings}"/>
                </TabControl>


                <!-- ===================== Launcher Overlay ===================== -->
                <!-- Launcher Dialog host after TabControl so it naturally renders above/over it -->
                <Grid Grid.Row="0" Grid.RowSpan="99" IsHitTestVisible="{Binding LauncherDialog.IsOpen}">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding LauncherDialog.IsOpen}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>

                    <!-- Dimming the background -->
                    <Border Background="#80000000"
                            CornerRadius="{DynamicResource CornerRadius.CurrentStyle}"/>

                    <ContentControl Content="{Binding LauncherDialog}"
                                    ContentTemplate="{StaticResource LauncherDialogTemplate}"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Margin="0"/>
                    <ContentPresenter x:Name="PART_SelectedContentHost"
                                      ContentSource="SelectedContent"/>
                </Grid>



                <!-- ===================== Dialog Views ===================== -->
                <Grid Grid.Row="0" Visibility="{Binding DialogGridVisibility}" Grid.RowSpan="99" Panel.ZIndex="99">

                    <!-- Language Selection Dialog (first-run only) -->
                    <Grid Visibility="{Binding CultureDialog.IsOpen, Converter={StaticResource BoolToVisibility}}"
                          IsHitTestVisible="{Binding CultureDialog.IsOpen}">
                        <dvw:CultureDialogView DataContext="{Binding CultureDialog}"/>
                    </Grid>

                    <!-- App About Dialog -->
                    <Grid Visibility="{Binding AboutDialog.IsOpen, Converter={StaticResource BoolToVisibility}}"
                          IsHitTestVisible="{Binding AboutDialog.IsOpen}">
                        <dvw:AboutDialogView DataContext="{Binding AboutDialog}"/>
                    </Grid>

                    <!-- App License Dialog -->
                    <Grid Visibility="{Binding LicenseDialog.IsOpen, Converter={StaticResource BoolToVisibility}}"
                          IsHitTestVisible="{Binding LicenseDialog.IsOpen}">
                        <dvw:LicenseDialogView DataContext="{Binding LicenseDialog}"/>
                    </Grid>

                    <!-- App Help Dialog -->
                    <Grid Visibility="{Binding HelpDialog.IsOpen, Converter={StaticResource BoolToVisibility}}"
                          IsHitTestVisible="{Binding HelpDialog.IsOpen}">
                        <dvw:HelpDialogView DataContext="{Binding HelpDialog}"/>
                    </Grid>

                    <!-- App Support Dialog -->
                    <Grid Visibility="{Binding SupportDialog.IsOpen, Converter={StaticResource BoolToVisibility}}"
                          IsHitTestVisible="{Binding SupportDialog.IsOpen}">
                        <dvw:SupportDialogView DataContext="{Binding SupportDialog}"/>
                    </Grid>

                    <!-- ===================== Modal Dialog ===================== -->
                    <!-- Modal dialog host AFTER everything -->
                    <Grid Visibility="{Binding ModalDialog.IsOpen, Converter={StaticResource BoolToVisibility}}"
                          IsHitTestVisible="{Binding ModalDialog.IsOpen}">
                        <dvw:ModalDialogView DataContext="{Binding ModalDialog}"/>
                    </Grid>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>
